<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Editable JSON Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #jsoneditor { height: 100vh; }
  </style>
</head>
<body>
  <div id="jsoneditor">Loading...</div>

  <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>
  <script>
    // Decode API key from base16
    function hexToString(hex) {
      let str = '';
      for (let i = 0; i < hex.length; i += 2) {
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
      }
      return str;
    }

    const apiKey = hexToString("41495a6153794447522d62476a537765787763436c31454c36734d366777307971355533583455"); // your base16-encoded key

    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const sheetId = getParam("sheetid");

    async function getSheetNames(sheetId) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title&key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.sheets.map(s => s.properties.title);
    }

    async function fetchSheetData(sheetId, sheetName) {
      const query = encodeURIComponent("Select *");
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tq=${query}`;
      try {
        const res = await fetch(url);
        const data = await res.text();
        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
        const headers = jsonData.table.cols.map(col => col.label || `Column${col.index}`);
        const rows = jsonData.table.rows.map(row => {
          let obj = {};
          row.c.forEach((cell, i) => {
            let value = null;
            if (cell) {
              value = cell.v;
              if (value === "TRUE") value = true;
              else if (value === "FALSE") value = false;
              else if (!isNaN(value) && value !== "") value = Number(value);
            }
            obj[headers[i]] = value;
          });
          return obj;
        });
        return rows;
      } catch (e) {
        return [`❌ Could not fetch data for sheet: ${sheetName}`];
      }
    }

    async function main() {
      const container = document.getElementById("jsoneditor");

      if (!sheetId) {
        container.innerText = "❗ sheetid missing in URL.";
        return;
      }

      try {
        const sheetNames = await getSheetNames(sheetId);
        const finalData = {};

        for (const name of sheetNames) {
          const rows = await fetchSheetData(sheetId, name);
          finalData[name] = rows;
        }

        const editor = new JSONEditor(container, {
          mode: 'code', // You can switch between 'code', 'tree', 'view', etc.
          modes: ['code', 'tree', 'view'], // Enable editing
          mainMenuBar: true
        });
        editor.set(finalData);
      } catch (e) {
        container.innerText = "❌ Failed to load data. Check API key or Sheet permission.";
      }
    }

    main();
  </script>
</body>
</html>
